name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed so moon can compare current HEAD to base

      - name: Setup toolchain (Moon + tools)
        uses: moonrepo/setup-toolchain@v0

      - name: Setup Moon toolchains
        run: moon setup

      - name: Setup PATH for Moon tools
        shell: bash
        run: |
          # Add proto's bin to PATH (Moon uses proto to manage tools)
          # This persists across steps using GITHUB_PATH
          echo "$HOME/.proto/bin" >> $GITHUB_PATH
          
          # Add Node.js to PATH if installed by proto
          if [ -d "$HOME/.proto/tools/node/22.20.0/bin" ]; then
            echo "$HOME/.proto/tools/node/22.20.0/bin" >> $GITHUB_PATH
          fi
          
          # Verify tools are available
          export PATH="$HOME/.proto/bin:$PATH"
          if [ -d "$HOME/.proto/tools/node/22.20.0/bin" ]; then
            export PATH="$HOME/.proto/tools/node/22.20.0/bin:$PATH"
          fi
          
          echo "Node.js version: $(node --version || echo 'not found')"
          
          # Verify pnpm is available, install if not
          if ! command -v pnpm &> /dev/null; then
            echo "pnpm not found, installing via npm..."
            npm install -g pnpm@10.18.0
            echo "$(npm config get prefix)/bin" >> $GITHUB_PATH
          fi
          echo "pnpm version: $(pnpm --version)"
          echo "pnpm location: $(which pnpm)"

      - name: Install dependencies
        run: moon run :install

      - name: Start development servers
        run: |
          # Start servers in background
          echo "Starting NestJS API on port 3000..."
          moon run api-nestjs:dev > /tmp/nestjs.log 2>&1 &
          NESTJS_PID=$!
          
          echo "Starting Go API on port 8080..."
          moon run api-golang:dev > /tmp/golang.log 2>&1 &
          GOLANG_PID=$!
          
          # Wait for servers to be ready
          echo "Waiting for servers to start..."
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            nestjs_ready=false
            golang_ready=false
            
            if curl -s http://localhost:3000/ > /dev/null 2>&1; then
              nestjs_ready=true
            fi
            
            if curl -s http://localhost:8080/ > /dev/null 2>&1; then
              golang_ready=true
            fi
            
            if [ "$nestjs_ready" = true ] && [ "$golang_ready" = true ]; then
              echo "✅ All servers are ready"
              break
            fi
            
            sleep 2
            elapsed=$((elapsed + 2))
            echo "Waiting... ($elapsed/$timeout seconds) - NestJS: $nestjs_ready, Go: $golang_ready"
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "❌ Servers failed to start within timeout"
            echo "NestJS logs:"
            cat /tmp/nestjs.log || true
            echo "Go API logs:"
            cat /tmp/golang.log || true
            exit 1
          fi
          
          # Store PIDs for cleanup
          echo "NESTJS_PID=$NESTJS_PID" >> $GITHUB_ENV
          echo "GOLANG_PID=$GOLANG_PID" >> $GITHUB_ENV

      - name: Run tests
        run: moon run :test

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up background processes..."
          # Kill specific processes if PIDs are set
          if [ -n "$NESTJS_PID" ]; then
            kill $NESTJS_PID 2>/dev/null || true
          fi
          if [ -n "$GOLANG_PID" ]; then
            kill $GOLANG_PID 2>/dev/null || true
          fi
          # Fallback: kill by process name
          pkill -f "moon run" || true
          pkill -f "nest start" || true
          pkill -f "go run" || true
          # Show logs if available
          if [ -f /tmp/nestjs.log ]; then
            echo "NestJS logs:"
            tail -50 /tmp/nestjs.log || true
          fi
          if [ -f /tmp/golang.log ]; then
            echo "Go API logs:"
            tail -50 /tmp/golang.log || true
          fi
